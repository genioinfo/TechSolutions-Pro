pipeline {
    agent any
    
    // Definir variables de entorno
    environment {
        DOCKER_IMAGE_BACKEND = 'techsolutions-backend'
        DOCKER_IMAGE_FRONTEND = 'techsolutions-frontend'
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        REGISTRY = 'dockerhub_usuario'  // Cambia esto por tu usuario de Docker Hub
    }
    
    // Par√°metros configurables
    parameters {
        string(name: 'BACKEND_PORT', defaultValue: '5001', description: 'Puerto del backend')
        string(name: 'FRONTEND_PORT', defaultValue: '8080', description: 'Puerto del frontend')
        booleanParam(name: 'DEPLOY', defaultValue: false, description: '¬øDesplegar despu√©s de construir?')
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üì• Obteniendo c√≥digo desde GitHub...'
                checkout scm
            }
        }
        
        stage('Build Backend') {
            steps {
                echo 'üî® Construyendo imagen Docker del Backend...'
                dir('backend') {
                    script {
                        sh """
                            docker build -t ${DOCKER_IMAGE_BACKEND}:${DOCKER_TAG} .
                            docker tag ${DOCKER_IMAGE_BACKEND}:${DOCKER_TAG} ${DOCKER_IMAGE_BACKEND}:latest
                        """
                    }
                }
            }
        }
        
        stage('Build Frontend') {
            steps {
                echo 'üî® Construyendo imagen Docker del Frontend...'
                dir('frontend') {
                    script {
                        sh """
                            docker build -t ${DOCKER_IMAGE_FRONTEND}:${DOCKER_TAG} .
                            docker tag ${DOCKER_IMAGE_FRONTEND}:${DOCKER_TAG} ${DOCKER_IMAGE_FRONTEND}:latest
                        """
                    }
                }
            }
        }
        
        stage('Test Backend') {
            steps {
                echo 'üß™ Ejecutando pruebas del Backend...'
                script {
                    sh """
                        docker run --rm ${DOCKER_IMAGE_BACKEND}:latest python -m pytest || echo "No hay tests configurados a√∫n"
                    """
                }
            }
        }
        
        stage('Deploy with Docker Compose') {
            when {
                expression { params.DEPLOY == true }
            }
            steps {
                echo 'üöÄ Desplegando aplicaci√≥n con Docker Compose...'
                script {
                    sh """
                        docker-compose down || true
                        docker-compose up -d
                    """
                }
            }
        }
        
        stage('Clean Up') {
            steps {
                echo 'üßπ Limpiando im√°genes antiguas...'
                script {
                    sh """
                        docker image prune -f
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo '‚úÖ Pipeline ejecutado exitosamente!'
        }
        failure {
            echo '‚ùå Pipeline fall√≥. Revisa los logs.'
        }
        always {
            echo 'üèÅ Pipeline finalizado.'
        }
    }
}
